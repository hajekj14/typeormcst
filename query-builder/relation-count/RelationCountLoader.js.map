{"version":3,"sources":["../../src/query-builder/relation-count/RelationCountLoader.ts"],"names":[],"mappings":"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","file":"RelationCountLoader.js","sourcesContent":["import {ColumnMetadata} from \"../../metadata/ColumnMetadata\";\r\nimport {QueryBuilder} from \"../QueryBuilder\";\r\nimport {Connection} from \"../../connection/Connection\";\r\nimport {QueryRunnerProvider} from \"../../query-runner/QueryRunnerProvider\";\r\nimport {RelationCountAttribute} from \"./RelationCountAttribute\";\r\nimport {RelationCountLoadResult} from \"./RelationCountLoadResult\";\r\n\r\nexport class RelationCountLoader {\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Constructor\r\n    // -------------------------------------------------------------------------\r\n\r\n    constructor(protected connection: Connection,\r\n                protected queryRunnerProvider: QueryRunnerProvider|undefined,\r\n                protected relationCountAttributes: RelationCountAttribute[]) {\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Public Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    async load(rawEntities: any[]): Promise<RelationCountLoadResult[]> {\r\n\r\n        const promises = this.relationCountAttributes.map(async relationCountAttr => {\r\n\r\n            if (relationCountAttr.relation.isOneToMany) {\r\n                // example: Post and Category\r\n                // loadRelationCountAndMap(\"post.categoryCount\", \"post.categories\")\r\n                // we expect it to load array of post ids\r\n\r\n                // todo(dima): fix issues wit multiple primary keys and remove joinColumns[0]\r\n                const relation = relationCountAttr.relation; // \"category.posts\"\r\n                const inverseRelation = relation.inverseRelation!; // \"post.category\"\r\n                const referenceColumnName = inverseRelation.joinColumns[0].referencedColumn!.propertyName; // post id\r\n                const inverseSideTable = relation.inverseEntityMetadata.target; // Post\r\n                const inverseSideTableName = relation.inverseEntityMetadata.tableName; // post\r\n                const inverseSideTableAlias = relationCountAttr.alias || inverseSideTableName; // if condition (custom query builder factory) is set then relationIdAttr.alias defined\r\n                const inverseSidePropertyName = inverseRelation.propertyName; // \"category\" from \"post.category\"\r\n\r\n                const referenceColumnValues = rawEntities\r\n                    .map(rawEntity => rawEntity[relationCountAttr.parentAlias + \"_\" + referenceColumnName])\r\n                    .filter(value => !!value);\r\n\r\n                // ensure we won't perform redundant queries for joined data which was not found in selection\r\n                // example: if post.category was not found in db then no need to execute query for category.imageIds\r\n                if (referenceColumnValues.length === 0)\r\n                    return { relationCountAttribute: relationCountAttr, results: [] };\r\n\r\n                // generate query:\r\n                // SELECT category.post as parentId, COUNT(category.id) AS cnt FROM category category WHERE category.post IN (1, 2) GROUP BY category.post\r\n                const qb = new QueryBuilder(this.connection, this.queryRunnerProvider);\r\n                qb.select(inverseSideTableAlias + \".\" + inverseSidePropertyName, \"parentId\")\r\n                    .addSelect(\"COUNT(\" + qb.escapeAlias(inverseSideTableAlias) + \".\" + qb.escapeColumn(referenceColumnName) + \")\", \"cnt\")\r\n                    .from(inverseSideTable, inverseSideTableAlias)\r\n                    .where(inverseSideTableAlias + \".\" + inverseSidePropertyName + \" IN (:ids)\")\r\n                    .addGroupBy(inverseSideTableAlias + \".\" + inverseSidePropertyName)\r\n                    .setParameter(\"ids\", referenceColumnValues);\r\n\r\n                // apply condition (custom query builder factory)\r\n                if (relationCountAttr.queryBuilderFactory)\r\n                    relationCountAttr.queryBuilderFactory(qb);\r\n\r\n                return {\r\n                    relationCountAttribute: relationCountAttr,\r\n                    results: await qb.getRawMany()\r\n                };\r\n\r\n            } else {\r\n                // example: Post and Category\r\n                // owner side: loadRelationIdAndMap(\"post.categoryIds\", \"post.categories\")\r\n                // inverse side: loadRelationIdAndMap(\"category.postIds\", \"category.posts\")\r\n                // we expect it to load array of post ids\r\n\r\n                let joinTableColumnName: string;\r\n                let inverseJoinColumnName: string;\r\n                let firstJunctionColumn: ColumnMetadata;\r\n                let secondJunctionColumn: ColumnMetadata;\r\n\r\n                if (relationCountAttr.relation.isOwning) { // todo fix joinColumns[0] and inverseJoinColumns[0].\r\n                    joinTableColumnName = relationCountAttr.relation.joinColumns[0].referencedColumn!.databaseName;\r\n                    inverseJoinColumnName = relationCountAttr.relation.inverseJoinColumns[0].referencedColumn!.databaseName;\r\n                    firstJunctionColumn = relationCountAttr.relation.junctionEntityMetadata!.columns[0];\r\n                    secondJunctionColumn = relationCountAttr.relation.junctionEntityMetadata!.columns[1];\r\n\r\n                } else {\r\n                    joinTableColumnName = relationCountAttr.relation.inverseRelation!.inverseJoinColumns[0].referencedColumn!.databaseName;\r\n                    inverseJoinColumnName = relationCountAttr.relation.inverseRelation!.joinColumns[0].referencedColumn!.databaseName;\r\n                    firstJunctionColumn = relationCountAttr.relation.junctionEntityMetadata!.columns[1];\r\n                    secondJunctionColumn = relationCountAttr.relation.junctionEntityMetadata!.columns[0];\r\n                }\r\n\r\n                const referenceColumnValues = rawEntities\r\n                    .map(rawEntity => rawEntity[relationCountAttr.parentAlias + \"_\" + joinTableColumnName])\r\n                    .filter(value => value);\r\n\r\n                // ensure we won't perform redundant queries for joined data which was not found in selection\r\n                // example: if post.category was not found in db then no need to execute query for category.imageIds\r\n                if (referenceColumnValues.length === 0)\r\n                    return { relationCountAttribute: relationCountAttr, results: [] };\r\n\r\n                const junctionAlias = relationCountAttr.junctionAlias;\r\n                const inverseSideTableName = relationCountAttr.joinInverseSideMetadata.tableName;\r\n                const inverseSideTableAlias = relationCountAttr.alias || inverseSideTableName;\r\n                const junctionTableName = relationCountAttr.relation.junctionEntityMetadata!.tableName;\r\n                const condition = junctionAlias + \".\" + firstJunctionColumn.propertyName + \" IN (\" + referenceColumnValues + \")\" +\r\n                    \" AND \" + junctionAlias + \".\" + secondJunctionColumn.propertyName + \" = \" + inverseSideTableAlias + \".\" + inverseJoinColumnName;\r\n\r\n                const qb = new QueryBuilder(this.connection, this.queryRunnerProvider);\r\n                qb.select(junctionAlias + \".\" + firstJunctionColumn.propertyName, \"parentId\")\r\n                    .addSelect(\"COUNT(\" + qb.escapeAlias(inverseSideTableAlias) + \".\" + qb.escapeColumn(inverseJoinColumnName) + \")\", \"cnt\")\r\n                    .fromTable(inverseSideTableName, inverseSideTableAlias)\r\n                    .innerJoin(junctionTableName, junctionAlias, condition)\r\n                    .addGroupBy(junctionAlias + \".\" + firstJunctionColumn.propertyName);\r\n\r\n                // apply condition (custom query builder factory)\r\n                if (relationCountAttr.queryBuilderFactory)\r\n                    relationCountAttr.queryBuilderFactory(qb);\r\n\r\n                return {\r\n                    relationCountAttribute: relationCountAttr,\r\n                    results: await qb.getRawMany()\r\n                };\r\n            }\r\n        });\r\n\r\n        return Promise.all(promises);\r\n    }\r\n\r\n}"],"sourceRoot":"../.."}